{% import 'numberplate.njk' as numberPlateButton %}
<div id="nlmaps-holder-ideas-on-map">
    <div id="map-with-buttons-container">
        <div id="{{editorInputElementId}}" style="width: 100%; height: 400px;"></div>
        <div class="map-buttons-container">
            {% if (data.widget.displayCtaButton) %}
            <a href="{{data.widget.ctaUrl}}" class="page-button page-button-blue page-button-flag">
                {{ data.widget.ctaText if data.widget.ctaText else 'Voeg een idee toe' }}
            </a>
            {% endif %}
            {% if (data.widget.displayCounter) %}
            {{numberPlateButton.numberPlateButton('no-of-locations', data.widget.counterText, data.ideas.length, '#')}}
            {% endif %}
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css">
<script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
<script src="https://nlmaps.nl/dist/nlmaps.iife.js"></script>

<script>

    //Load polygon from global settings
    var polygonLngLat = {% if data.global.mapPolygons %}{{ data.global.mapPolygons | dump | safe }}{% else %}null{% endif %};

    var centerLat = {% if data.global.mapCenterLat %}{{ data.global.mapCenterLat | dump | safe }}{% else %}4.2322689{% endif %};
    var centerLng = {% if data.global.mapCenterLng %}{{ data.global.mapCenterLng | dump | safe }}{% else %}52.04946{% endif %};
    var mapZoomLevel = {% if data.global.mapZoomLevel %}{{ data.global.mapZoomLevel | dump | safe }}{% else %}15{% endif %};

    var markers = [];
    //Create a marker for every plan
    {% for idea in data.ideas %}
    {% if (idea.location) and (idea.status != 'DENIED' or ideas.length == 1) %}
    {% if (idea.location.coordinates[0]) and (idea.location.coordinates[1]) %}

    var themes = {{ data.global.themes | json }};
    var flag = '/img/idea/flag-blue-dh.png';

    if ('{{idea.status}}' == 'CLOSED' || '{{idea.status}}' == 'DENIED') {
        flag = '/img/idea/flag-gray.png';
    } else {
        if (themes && themes.length > 0) {
            var selectedTheme = themes.filter(function (theme) {
                // todo: Can we match this in another way besides theme name?
                return theme.value == '{{ idea.extraData.theme }}';
            });

            if (selectedTheme && selectedTheme.length == 1) {
                flag = '/img/idea/flag-' + selectedTheme[0].flag + '.png';
            }
        }
    }

    var markerUrl = flag || '/img/idea/flag-blue-dh.png';

    var marker = new ol.Feature({
        geometry: new ol.geom.Point(
            ol.proj.fromLonLat([{{idea.location.coordinates[1]}}, {{idea.location.coordinates[0]}}])
        ),
        href: '/{{data.global.ideaSlug}}/{{idea.id}}',
        name: 'marker',
        category: '{{idea.extraData.theme}}'
    });
    marker.setStyle(new ol.style.Style({
        image: new ol.style.Icon({
            crossOrigin: 'anonymous',
            anchorOrigin: 'bottom-left',
            anchor: [0, 0],
            anchorXUnits: 'pixels',
            anchorYUnits: 'pixels',
            src: markerUrl,
            size: [25, 25],
            offset: [0, 0]
        }),
    }));

    markers.push(marker);

    {% endif %}
    {% endif %}
    {% endfor %}

</script>
