{% import 'numberplate.njk' as numberPlateButton %}
<div id="nlmaps-holder">
    <div id="map-with-buttons-container">
        <div id="{{editorInputElementId}}" style="width: 100%; height: 400px;"></div>
        <div class="map-buttons-container">
            {% if (data.widget.displayCtaButton) %}
            <a href="{{data.widget.ctaUrl}}" class="page-button page-button-blue page-button-flag">
                {{ data.widget.ctaText if data.widget.ctaText else 'Voeg een opknappunt toe' }}
            </a>
            {% endif %}
            {% if (data.widget.displayCounter) %}
            {{numberPlateButton.numberPlateButton('no-of-locations', data.widget.counterText, data.ideas.length, '#')}}
            {% endif %}
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css">
<script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
<script src="https://nlmaps.nl/dist/nlmaps.iife.js"></script>

<script>

    var nlMapsHolder = document.getElementById('nlmaps-holder');
    nlMapsHolder.style.height = '400px'; // Change to required height

    const GeoJSON = ol.format.GeoJSON;
    const VectorLayer = ol.layer.Vector;
    const VectorSource = ol.source.Vector;
    const Style = ol.style.Style;
    const Fill = ol.style.Fill;
    const Stroke = ol.style.Stroke;
    const MultiPoint = ol.geom.MultiPoint;
    const Marker = nlmaps.openlayers.markerLayer;


    //Style for polygon
    var styles = [
        new Style({
            stroke: new Stroke({
                color: 'black',
                width: 3
            }),
            fill: new Fill({
                color: 'rgba(0, 0, 0, 0.1)'
            })
        }),
        new Style({
            geometry: function(feature) {
                // return the coordinates of the first ring of the polygon
                var coordinates = feature.getGeometry().getCoordinates()[0];
                return new MultiPoint(coordinates);
            }
        })
    ];

    //Load polygon from global settings
    var polygonLngLat = {% if data.global.mapPolygons %}{{ data.global.mapPolygons | dump | safe }}{% else %}null{% endif %};

    //transform lnglat array to Spherical Mercator (EPSG:3857)
    var polygonCoords = [];
    polygonLngLat.forEach(function(pointPair){
        var newPair = ol.proj.fromLonLat([pointPair.lng, pointPair.lat], 'EPSG:3857');
        polygonCoords.push(newPair);
    });

    var geojsonObject = {
        'type': 'FeatureCollection',
        'crs': {
            'type': 'name',
            'properties': {
                'name': 'EPSG:3857'
            }
        },
        'features': [{
            'type': 'Feature',
            'geometry': {
                'type': 'Polygon',
                'coordinates': [polygonCoords]
            }
        }]
    };

    var source = new VectorSource({
        features: (new GeoJSON()).readFeatures(geojsonObject)
    });

    var layer = new VectorLayer({
        source: source,
        style: styles
    });

    var opts = {
        style: 'standaard',
        target: 'nlmaps-holder',
        center: {
            longitude: 4.2322689,
            latitude: 52.04946
        },
        overlay: 'gebouwen',
        search: false,
        zoom: 15.3
    };

    //create map
    var map = nlmaps.createMap(opts);
    map.addLayer(layer);

    //Create a marker for every plan
    {% for idea in data.ideas %}
    {% if (idea.location) and (idea.status != 'DENIED' or ideas.length == 1) %}
    {% if (idea.location.coordinates[0]) and (idea.location.coordinates[1]) %}

    var markerColorMapping = {
        'DONE': '/img/idea/flag-blue.svg',
        'ACCEPTED': '/img/idea/flag-blue.svg',
        'BUSY': '/img/idea/flag-blue.svg',
        'CLOSED': '/img/idea/flag-gray.svg',
        'DENIED': '/img/idea/flag-gray.svg'
    };

    var markerUrl = markerColorMapping['{{idea.status}}'] || '/img/idea/flag-blue.svg';

    var marker = new ol.Feature({
        geometry: new ol.geom.Point(
            ol.proj.fromLonLat([{{idea.location.coordinates[1]}}, {{idea.location.coordinates[0]}}])
        ),
    });
    marker.setStyle(new ol.style.Style({
        image: new ol.style.Icon(({
            crossOrigin: 'anonymous',
            src: markerUrl
        }))
    }));
    var vectorSource = new VectorSource({
        features: [marker]
    });
    var vectorLayer = new VectorLayer({
        source: vectorSource
    });
    map.addLayer(vectorLayer);

    {% endif %}
    {% endif %}
    {% endfor %}

/*    document.getElementsByClassName('nlmaps-geocoder-control-container').appendChild(
        document.getElementsByClassName('ol-viewport')
    );*/

    document.addEventListener("DOMContentLoaded", function() {
        $('.ol-viewport').append($('.nlmaps-geocoder-control-container'));
    });

</script>
