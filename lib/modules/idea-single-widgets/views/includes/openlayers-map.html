{% set idea = data.idea %}

<div id="nlmaps-holder-single-idea">
</div>

<link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css">
<script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
<script src="https://nlmaps.nl/dist/nlmaps.iife.js"></script>

<script>

    var nlMapsHolder = document.getElementById('nlmaps-holder-single-idea');

    if (!!nlMapsHolder) {
        nlMapsHolder.style.height = '400px'; // Change to required height

        var GeoJSON      = ol.format.GeoJSON;
        var VectorLayer  = ol.layer.Vector;
        var VectorSource = ol.source.Vector;
        var Style        = ol.style.Style;
        var Fill         = ol.style.Fill;
        var Stroke       = ol.style.Stroke;
        var MultiPoint   = ol.geom.MultiPoint;
        var Marker       = nlmaps.openlayers.markerLayer;

        //Load polygon from global settings
        var polygonLngLat = {% if data.global.mapPolygons %}{{ data.global.mapPolygons | dump | safe }}{% else %}null{% endif %};
        var centerLat = {% if data.global.mapCenterLat %}{{ data.global.mapCenterLat | dump | safe }}{% else %}4.2322689{% endif %};
        var centerLng = {% if data.global.mapCenterLng %}{{ data.global.mapCenterLng | dump | safe }}{% else %}52.04946{% endif %};
        var mapZoomLevel = {% if data.global.mapZoomLevel %}{{ data.global.mapZoomLevel | dump | safe }}{% else %}15{% endif %};

        var opts = {
            style:   'standaard',
            target:  'nlmaps-holder-single-idea',
            center:  {
                longitude: centerLng,
                latitude:  centerLat
            },
            overlay: 'gebouwen',
            search:  false,
            zoom:    mapZoomLevel
        };

        //create map
        var map = nlmaps.createMap(opts);
        map.addLayer(buildInvertedPolygon());
        map.addLayer(buildOutlinedPolygon());


        {% if (idea.location) and (idea.status != 'DENIED' or ideas.length == 1) %}
        {% if (idea.location.coordinates[0]) and (idea.location.coordinates[1]) %}

        var markerColorMapping = {
            'DONE': '/img/idea/flag-blue-dh.png',
            'ACCEPTED': '/img/idea/flag-blue-dh.png',
            'BUSY': '/img/idea/flag-blue-dh.png',
            'CLOSED': '/img/idea/flag-gray.png',
            'DENIED': '/img/idea/flag-gray.png'
        };

        var markerUrl = markerColorMapping['{{idea.status}}'] || '/img/idea/flag-blue-dh.png';

        var marker = new ol.Feature({
            geometry: new ol.geom.Point(
                ol.proj.fromLonLat([{{idea.location.coordinates[1]}}, {{idea.location.coordinates[0]}}])
        ),
            href: '/{{data.global.ideaSlug}}/{{idea.id}}',
                name: 'marker',
                category: '{{idea.extraData.theme}}'
        });

        marker.setStyle(new ol.style.Style({
            image: new ol.style.Icon({
                crossOrigin: 'anonymous',
                anchorOrigin: 'bottom-left',
                anchor: [0, 0],
                anchorXUnits: 'pixels',
                anchorYUnits: 'pixels',
                src: markerUrl,
                size: [25, 25],
                offset: [0, 0]
            }),
        }));

        var vectorSource = new VectorSource({
            features: [marker]
        });

        var vectorLayer = new VectorLayer({
            source: vectorSource
        });

        map.addLayer(vectorLayer);

        {% endif %}
        {% endif %}
    }


    function getInvertCoordinates() {

        var coordinates = [{"lng": 0, "lat": 90},{"lng": 180, "lat": 90},{"lng": 180, "lat": -90},{"lng": 0, "lat": -90},{"lng": -180, "lat": -90},{"lng": -180, "lat": 0},{"lng": -180, "lat": 90},{"lng": 0, "lat": 90}];

        var invertCoords = [];
        coordinates.forEach(function (pointPair) {
            var newPair = ol.proj.fromLonLat([pointPair.lng, pointPair.lat], 'EPSG:3857');
            invertCoords.push(newPair);
        });

        return invertCoords;
    }

    function createInvertedGeojsonObject(coordinates) {
        var geojsonObject = {
            'type':     'FeatureCollection',
            'crs':      {
                'type':       'name',
                'properties': {
                    'name': 'EPSG:3857'
                }
            },
            'features': [{
                'type':     'Feature',
                'geometry': {
                    'type':        'Polygon',
                    'coordinates': [getInvertCoordinates(), coordinates]
                }
            }]
        };

        return geojsonObject;
    }

    function createGeojsonObject(coordinates) {
        var geojsonObject = {
            'type':     'FeatureCollection',
            'crs':      {
                'type':       'name',
                'properties': {
                    'name': 'EPSG:3857'
                }
            },
            'features': [{
                'type':     'Feature',
                'geometry': {
                    'type':        'Polygon',
                    'coordinates': [coordinates]
                }
            }]
        };

        return geojsonObject;
    }

    function getTransformedPolygon() {
        //transform lnglat array to Spherical Mercator (EPSG:3857)
        var polygonCoords = [];
        polygonLngLat.forEach(function (pointPair) {
            var newPair = ol.proj.fromLonLat([pointPair.lng, pointPair.lat], 'EPSG:3857');
            polygonCoords.push(newPair);
        });

        return polygonCoords;
    }


    function buildOutlinedPolygon() {
        //Style for the outlined polygon
        var outlineStyles = [
            new Style({
                stroke: new Stroke({
                    color: 'black',
                    width: 3
                })
            }),
            new Style({
                geometry: function (feature) {
                    // return the coordinates of the first ring of the polygon
                    var coordinates = feature.getGeometry().getCoordinates()[0];
                    return new MultiPoint(coordinates);
                }
            })
        ];

        var source = new VectorSource({
            features: (new GeoJSON()).readFeatures(createGeojsonObject(getTransformedPolygon()))
        });

        var outlinedLayer = new VectorLayer({
            source: source,
            style:   outlineStyles
        });

        return outlinedLayer;
    }

    function buildInvertedPolygon() {
        //Style for the inverted polygon
        var invertedStyles = [
            new Style({
                fill:   new Fill({
                    color: 'rgba(0, 0, 0, 0.2)'
                })
            }),
            new Style({
                geometry: function (feature) {
                    // return the coordinates of the first ring of the polygon
                    var coordinates = feature.getGeometry().getCoordinates()[0];
                    return new MultiPoint(coordinates);
                }
            })
        ];

        var source = new VectorSource({
            features: (new GeoJSON()).readFeatures(createInvertedGeojsonObject(getTransformedPolygon()))
        });

        var invertedLayer = new VectorLayer({
            source: source,
            style:   invertedStyles
        });

        return invertedLayer;
    }



</script>
