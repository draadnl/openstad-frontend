{% set idea = data.idea %}

<div id="nlmaps-holder-single-idea">
</div>

<link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css">
<script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
<script src="https://nlmaps.nl/dist/nlmaps.iife.js"></script>

<script>

    var nlMapsHolder = document.getElementById('nlmaps-holder-single-idea');

    if (!!nlMapsHolder) {
        nlMapsHolder.style.height = '400px'; // Change to required height

        var GeoJSON      = ol.format.GeoJSON;
        var VectorLayer  = ol.layer.Vector;
        var VectorSource = ol.source.Vector;
        var Style        = ol.style.Style;
        var Fill         = ol.style.Fill;
        var Stroke       = ol.style.Stroke;
        var MultiPoint   = ol.geom.MultiPoint;
        var Marker       = nlmaps.openlayers.markerLayer;

        //Style for polygon
        var styles = [
            new Style({
                stroke: new Stroke({
                    color: 'black',
                    width: 3
                }),
                fill:   new Fill({
                    color: 'rgba(0, 0, 0, 0.1)'
                })
            }),
            new Style({
                geometry: function (feature) {
                    // return the coordinates of the first ring of the polygon
                    var coordinates = feature.getGeometry().getCoordinates()[0];
                    return new MultiPoint(coordinates);
                }
            })
        ];

        //Load polygon from global settings
        var polygonLngLat = {% if data.global.mapPolygons %}{{ data.global.mapPolygons | dump | safe }}{% else %}null{% endif %};
        var centerLat = {% if data.global.mapCenterLat %}{{ data.global.mapCenterLat | dump | safe }}{% else %}4.2322689{% endif %};
        var centerLng = {% if data.global.mapCenterLng %}{{ data.global.mapCenterLng | dump | safe }}{% else %}52.04946{% endif %};
        var mapZoomLevel = {% if data.global.mapZoomLevel %}{{ data.global.mapZoomLevel | dump | safe }}{% else %}15{% endif %};

        //transform lnglat array to Spherical Mercator (EPSG:3857)
        var polygonCoords = [];
        polygonLngLat.forEach(function (pointPair) {
            var newPair = ol.proj.fromLonLat([pointPair.lng, pointPair.lat], 'EPSG:3857');
            polygonCoords.push(newPair);
        });

        var geojsonObject = {
            'type':     'FeatureCollection',
            'crs':      {
                'type':       'name',
                'properties': {
                    'name': 'EPSG:3857'
                }
            },
            'features': [{
                'type':     'Feature',
                'geometry': {
                    'type':        'Polygon',
                    'coordinates': [polygonCoords]
                }
            }]
        };

        var source = new VectorSource({
            features: (new GeoJSON()).readFeatures(geojsonObject)
        });

        var layer = new VectorLayer({
            source: source,
            style:  styles
        });

        var opts = {
            style:   'standaard',
            target:  'nlmaps-holder-single-idea',
            center:  {
                longitude: centerLng,
                latitude:  centerLat
            },
            overlay: 'gebouwen',
            search:  false,
            zoom:    mapZoomLevel
        };

        //create map
        var map = nlmaps.createMap(opts);
        map.addLayer(layer);


        {% if (idea.location) and (idea.status != 'DENIED' or ideas.length == 1) %}
        {% if (idea.location.coordinates[0]) and (idea.location.coordinates[1]) %}

        var markerColorMapping = {
            'DONE': '/img/idea/flag-blue-dh.svg',
            'ACCEPTED': '/img/idea/flag-blue-dh.svg',
            'BUSY': '/img/idea/flag-blue-dh.svg',
            'CLOSED': '/img/idea/flag-gray.svg',
            'DENIED': '/img/idea/flag-gray.svg'
        };

        var markerUrl = markerColorMapping['{{idea.status}}'] || '/img/idea/flag-blue-dh.svg';

        var marker = new ol.Feature({
            geometry: new ol.geom.Point(
                ol.proj.fromLonLat([{{idea.location.coordinates[1]}}, {{idea.location.coordinates[0]}}])
        ),
            href: '/{{data.global.ideaSlug}}/{{idea.id}}',
                name: 'marker',
                category: '{{idea.extraData.theme}}'
        });

        marker.setStyle(new ol.style.Style({
            image: new ol.style.Icon({
                crossOrigin: 'anonymous',
                anchorOrigin: 'bottom-left',
                anchor: [0, 0],
                anchorXUnits: 'pixels',
                anchorYUnits: 'pixels',
                src: markerUrl,
                offset: [0, 0]
            }),
        }));

        var vectorSource = new VectorSource({
            features: [marker]
        });

        var vectorLayer = new VectorLayer({
            source: vectorSource
        });

        map.addLayer(vectorLayer);

        {% endif %}
        {% endif %}
    }

</script>
